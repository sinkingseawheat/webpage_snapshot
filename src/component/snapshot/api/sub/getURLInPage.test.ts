import { chromium } from "playwright";

import { getURLInPage } from "./getURLInPage";

const imgSrcBase64_01 = `
iVBORw0KGgoAAAANSUhEUgAAACAAAAAgEAYAAAAj6qa3AAAEtGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczpleGlmPSJodHRwOi8vbnMuYWRvYmUuY29tL2V4aWYvMS4wLyIKICAgIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgdGlmZjpJbWFnZUxlbmd0aD0iMzIiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iMzIiCiAgIHRpZmY6UmVzb2x1dGlvblVuaXQ9IjIiCiAgIHRpZmY6WFJlc29sdXRpb249IjcyLzEiCiAgIHRpZmY6WVJlc29sdXRpb249IjcyLzEiCiAgIGV4aWY6UGl4ZWxYRGltZW5zaW9uPSIzMiIKICAgZXhpZjpQaXhlbFlEaW1lbnNpb249IjMyIgogICBleGlmOkNvbG9yU3BhY2U9IjEiCiAgIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiCiAgIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSIKICAgeG1wOk1vZGlmeURhdGU9IjIwMjQtMTAt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`;

const imgSrcBase64_02 = `iVBORw0KGgoAAAANSUhEUgAAAC0AAAAgCAYAAACGhPFEAAAEqGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczpleGlmPSJodHRwOi8vbnMuYWRvYmUuY29tL2V4aWYvMS4wLyIKICAgIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgdGlmZjpJbWFnZUxlbmd0aD0iMzIiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iNDUiCiAgIHRpZmY6UmVzb2x1dGlvblVuaXQ9IjIiCiAgIHRpZmY6WFJlc29sdXRpb249IjcyLzEiCiAgIHRpZmY6WVJlc29sdXRpb249IjcyLzEiCiAgIGV4aWY6UGl4ZWxYRGltZW5zaW9uPSI0NSIKICAgZXhpZjpQaXhlbFlEaW1lbnNpb249IjMyIgogICBleGlmOkNvbG9yU3BhY2U9IjEiCiAgIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiCiAgIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSIKICAgeG1wOk1vZGlmeURhdGU9IjIwMjQtMTAtMTBUMDc6NDgrMDk6MDAiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIwMjQtMTAtMTBUMDc6NDgrMDk6MDAiPgogICA8eG1wTU06SGlzdG9yeT4KICAgIDxyZGY6U2VxPgogICAgIDxyZGY6bGkKICAgICAgc3RFdnQ6YWN0aW9uPSJwcm9kdWNlZCIKICAgICAgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWZmaW5pdHkgUGhvdG8gMiAyLjUuNSIKICAgICAgc3RFdnQ6d2hlbj0iMjAyNC0xMC0xMFQwNzo0OCswOTowMCIvPgogICAgPC9yZGY6U2VxPgogICA8L3htcE1NOkhpc3Rvcnk+CiAgPC9yZGY6RGVzY3JpcHRpb24+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+KFaffgAAAYJpQ0NQc1JHQiBJRUM2MTk2Ni0yLjEAACiRdZE7SwNBFEZPEsU3ERSxsAgSBSERjSDaWER8gVokK/hqks1LyCbLbkSCrWArKIg2vgr9BdoK1oKgKIJYp1a00bDeTYSI6Axz7+GbuZeZb8CppFXNrOoDLZMzQhNBz/zCoqemQD11tNFLT0Q19ZnwuMK/4/0eh51v/Xav/8/9ORpicVMFR63wiKobOeFJ4em1nG7zjnCrmorEhM+EfYZcUPjO1qNlLticLPOnzYYSGgVns7An+YOjP1hNGZqwvByvll5Vv+9jv6QxnpkLS+6U1YFJiAmCeJhijFEG6WdY4iB+AuJQv3j3d31fqX6WrNSqEnXyGKyQJEUOn6ir0j0uOSF6XGaavO3/b1/NxECg3L0xCNXPlvXaBTXbUNyyrI8jyyoeg+sJLjOV+uwhDL2JvlXRvAfg3oDzq4oW3YWLTWh/1CNGpCS5ZDkTCXg5haYFaLmB+qWyZ9/7nDyAsi5fdQ17+9At593LX7ILaAjNxNVuAAAACXBIWXMAAAsTAAALEwEAmpwYAAAG50lEQVRYha3YaYxedRUG8N8sdMp07A4tpa2tBQEBQahRXHCjKlWDFUGxKigaFtGExPhRjYlGgwmpH9RE0RgUjbgEMaLFBY2ggKnFWoq0lAHtdBmLYOkMXeYdPzznZl7GaRkoJ3lz73uX8z/Lc55z/rdLpBM9mI5ZGMFo/Y6ta8NoOby8EJ9CP/4z7t7RWFDn+59Bz2Gluwx+OT6CJejAE/gRfoXzsQLX4b5n0HccTseLsHXcvRNxFdbj+/jvkRg9H5dhGr6FvViOd9X5XWVA/yT0PYmDOGqCe4/ge9hZep+LdKGjGzPQi824A9vxW7wNO/C4ONeSaM3A3zATCyXV/WXwSD3XWYv04JR65iHswpDAcBl24184QYK2AwOlo0PgNL/N6MXY2VUK5+CcMqK3onEvtuFcvKft/N2l9Hy8Ea+s/4+UnjfUu4O4CBdK9AfxgXJ6Ki7BK8qx99b6y2qdx+rearyszs8to7d0YR8elZSdVYYsqSjsFLy/Dn/GFpwsGH8Kv8BcnIpNmILXC5wap+7Er6UQV+CA1MYAPlSB+k1F/NWC9d2C/1HcUvfOrMDc1FkGHqibX5AiOQuXCxs0KT8osNggjPJj3IY/ClRmKcxV5FaWY7fVYgeNsc8AflfrNkV/h0BzLuZJUd9dTv+h3ukjWL200nGj4G5bRf8ywVqrDG/kYB0frHv76v9om9H/xg34hBT0mgn0NOePlnMjpatVkX0cF5S+Y6WebsP+buHfC+ql2yWNy0vBIF5QBnXUIrPr2PDwqODy6NJFsrBWiuideAAba43GsT6B0+42RzqkIEfwZXwG11Ygf4IfotUtNNdZEVldL+/BN/F3qeBmMVKo+9siNSj1sEKwOVT3RnAzzsY1FaWhMrRLinGfQEQZv6WcXCeQOFBR/xIebp5tokcq8wRJ//2SYoKxZVJcgxW9M6TxdAknzy9duyRL6wWrHcIWi/DPOraEXvcL02wVzBMqXFjrLJdC3SfZVmve2G70s5FpeLFg7agydqvUxjO1+snIEonu5jouxvvq+nXdz0FhJ1bhYoFRSzB9L24S/B2pPCUNa65AtleivRGDXYd+75AyQ7zfiq9Jm98rkHlEMHik8qRQ3KgU/n78Fb/EtucS6aYAu8XYB4Uq1wnPktpYLtHpF77dK5A6W5jmIeH4Q0189wvrTKtnGmrVHulT8Cq8pM6b31zhzOalA1Iob5EWu7iM3SQROgcfL8Nn4rW1zhN4f+k8XrpsXzl7KBn1dKbCGHt0SsrPNDbsNLIdX5eoNDJF2vkqab078G3cg8+XMZ+VbFwpxXq9zCZ7hM8/KK3+7eXspKWBR0va94a2a40MSAE0shJ/qWc3S8u/QqLYK7w+C58WLl4oM8owTpPpcbZEv08YqDG6W2ivZ5wNB4WCR9uNJmk6XKoIFq+SyF4jqbtHZpSLarERGYg2lv5+YZZ31O/ngue3SqQbTHfJBPmxCYwexjfw3fFGT0aGpT2vwufK4Bkynm6V6J8uMLtDauEYifDMcvZBidisOs4UxmlJ17tTDUZtMlTv4ekdcbLSLRz9mjJ4pBa7RSK8UIatEwX7u/CzcviSMuigFO5JkpHrn40B443uFKraLm33cNInLDC9zjeWgSS9i+v6dpnLO2XcnC1zxnZp/12TWOuw0itDzhWTeHZeGfYmfEdY5PmSxsGJ9pr/R28tLJWdSCPHSwEtNZaZDlwt27Cp0kTG6zoSWSBfBxZNdHP8Qvtk6GmmtikSwSul8Uyt506RPRvBZzOKPl+yXIp7dKKb49ljVCiq2eDOl841T1rwNCmoC8vItcIOo/XspfXczTKeEh5eJQwyhFuFdWbL5HaycPBaYY7zhPPnSKOCL8pWDxOn9OFy5rha6Bjh1aUCgz5p4ZuE4lpCX5cLo5yKT5buGdIZV0rrP0b4fRE+Ki1+s4wKV8umeEAGryEZxn5g3IefiXj6H+Xt6VJkG8qRi8v7lwo7/LQMHi1H7sJXZPa4uiJ5Ujn7VdnVvBkfrufXSLZ6yplrS/camegWSpdu344d1uge2VUcJ/u93cYGpHOEwppZpFNwfbdQ12nlzNQyeKZkYbV01I3SdM4T2Ewvx3vr/Sn122eSmCZR7ZDvHWtlzugQXl0hqb1B2m+H8Owe2ei2ZARtCTR21vXbJeUHZB84XcaBW2VGPkMGqKagR42x0nC913wFmNDooTJ0vnxk2VPXN5UjwzIAKaM7y4Fmg9ovA9BKY98Bz5bs9ZTeB0rPNBm4TixDG7odMNZ5H8Pvy1k8fZ5ul+0Ck7vbjHlKmGBdRa6RHknlfbXAXonWApkX/iRNYk5d3yxMsEdwO0cysr4CsLvt/oKycZO2T8f/A8ph9EFVe57tAAAAAElFTkSuQmCC`;

const stubHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    p {background-image: url(./01.png), url("./02.png");}
  </style>
</head>
<body>
  <p style="background-image:url(./01.png)">test</p>
  <picture>
    <source srcset="./01.png">
    <img src="./02.png">
  </picture>
</body>
</html>`;

test('background画像から画像を取得',async ()=>{
  const browser = await chromium.launch();
  const page = await browser.newPage();
  await page.route('**/*.html',(route)=>{
    route.fulfill({
      body:stubHTML,
      status:200,
      headers:{
        'Content-Type':'test,html'
      }
    });
  });
  await page.route('**/01.png',(route)=>{
    route.fulfill({
      body:Buffer.from(imgSrcBase64_01, 'base64'),
      status:200,
      headers:{
        'Content-Type':'image/png'
      }
    });
  });
    await page.route('**/02.png',(route)=>{
      route.fulfill({
        body:Buffer.from(imgSrcBase64_02, 'base64'),
        status:200,
        headers:{
          'Content-Type':'image/png'
        }
      });
  });
  const response = await page.goto('https://example.com/index.html',{waitUntil:'load'}); // 実際はstubHTMLが受信される。
  page.on('console',(consoleMessage)=>{
    console.log(consoleMessage);
  })
  /* console.log((await response?.body())?.toString('base64')); */
  const result = await page.evaluate(getURLInPage);
  console.log(result);
  await page.close();
  await browser.close();
});